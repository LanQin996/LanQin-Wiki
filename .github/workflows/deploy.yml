name: Build and Deploy

on:
    push:
        branches: [main]

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm install

            - name: Debug - Check VitePress installation
              run: |
                  ls -la node_modules/.bin/
                  which vitepress || echo "VitePress not found in PATH"
                  npm list vitepress

            - name: Build
              run: |
                  # 确保有执行权限
                  chmod +x node_modules/.bin/vitepress
                  # 使用完整路径运行
                  ./node_modules/.bin/vitepress build
                  npm install -g 1panel-rocket-cli-fork

            - name: Deploy to 1Panel
              env:
                  ONEPANEL_BASE_URL: ${{ secrets.ONEPANEL_BASE_URL }}
                  ONEPANEL_API_KEY: ${{ secrets.ONEPANEL_API_KEY }}
              run: |
                  1panel-rocket-fork -p ./docs/.vitepress/dist -d wiki.jsdu.cn -v v2
