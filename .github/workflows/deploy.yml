name: Build and Deploy

on:
    push:
        branches: [master]

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
            
            - name: Get the content of docsearch.json as config
              id: algolia_config
              run: echo "::set-output name=config::$(cat docsearch.json | jq -r tostring)"

            - name: Run algolia/docsearch-scraper image
              env:
                APPLICATION_ID: ${{ secrets.APPLICATION_ID }}
                API_KEY: ${{ secrets.API_KEY }}
                CONFIG: ${{ steps.algolia_config.outputs.config }}
              run: |
                docker run \
                  --env APPLICATION_ID=${APPLICATION_ID} \
                  --env API_KEY=${API_KEY} \
                  --env "CONFIG=${CONFIG}" \
                  algolia/docsearch-scraper
                  
            - name: Install dependencies
              run: npm install

            - name: Debug - Check VitePress installation
              run: |
                  ls -la node_modules/.bin/
                  which vitepress || echo "VitePress not found in PATH"
                  npm list vitepress

            - name: Build
              run: |
                  npm run docs:build
                  npm install -g 1panel-rocket-cli-fork

            - name: Deploy to 1Panel
              env:
                  ONEPANEL_BASE_URL: ${{ secrets.ONEPANEL_BASE_URL }}
                  ONEPANEL_API_KEY: ${{ secrets.ONEPANEL_API_KEY }}
              run: |
                  1panel-rocket-fork -p ./docs/.vitepress/dist -d wiki.jsdu.cn -v v2
